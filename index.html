<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Oráculo Crypto — IA de Sinais</title>
  <meta name="description" content="Demonstração de um aplicativo web de IA que analisa cripto em tempo real e gera sinais de COMPRAR/VENDER.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg: #0b0f19;          /* Black / Navy night */
      --bg-2:#0f1424;
      --card:#131a2a;         /* Card surface */
      --elev:#182136;         /* Elevated */
      --line:#24304d;         /* Borders */
      --text:#e6eefd;         /* Primary text */
      --muted:#9fb0d1;        /* Secondary */
      --acc:#5eead4;          /* Accent (teal) */
      --acc-2:#60a5fa;        /* Accent (blue) */
      --buy:#22c55e;
      --sell:#ef4444;
      --warn:#f59e0b;
      --ok:#10b981;
      --bad:#ef4444;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;background:radial-gradient(1200px 800px at 15% -10%,#122040 0%,rgba(18,32,64,0) 60%),radial-gradient(1400px 900px at 120% 10%,#1a2b52 0%,rgba(26,43,82,0) 60%),var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,Apple Color Emoji,Noto Color Emoji,sans-serif;-webkit-font-smoothing:antialiased;line-height:1.45;margin:0}
    a{color:var(--acc-2);text-decoration:none}
    .app{display:grid;grid-template-rows:auto 1fr;min-height:100dvh}
    /* Header */
    .nav{position:sticky;top:0;backdrop-filter:saturate(1.3) blur(10px);background:linear-gradient(180deg,rgba(11,15,25,.86),rgba(11,15,25,.70));border-bottom:1px solid var(--line);z-index:50}
    .nav-inner{display:flex;align-items:center;gap:16px;max-width:1200px;margin:0 auto;padding:14px 18px}
    .logo{display:flex;align-items:center;gap:10px}
    .logo-badge{width:36px;height:36px;border-radius:12px;background:linear-gradient(135deg,#0ea5e9 0%,#22d3ee 35%,#14b8a6 60%,#10b981 100%);box-shadow:0 10px 30px rgba(16,185,129,.3);display:grid;place-items:center}
    .logo svg{filter:drop-shadow(0 4px 12px rgba(94,234,212,.35))}
    .title{font-weight:800;letter-spacing:.2px}
    .pill{margin-left:auto;display:flex;gap:10px;align-items:center}
    .status{display:flex;gap:8px;align-items:center;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:linear-gradient(180deg,rgba(19,26,42,.8),rgba(19,26,42,.5))}
    .dot{width:8px;height:8px;border-radius:999px;background:var(--ok);box-shadow:0 0 0 2px rgba(16,185,129,.2)}
    .latency{color:var(--muted);font-size:12px}
    .gear{display:grid;place-items:center;width:36px;height:36px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(19,26,42,.8),rgba(19,26,42,.5));cursor:pointer}
    .gear:active{transform:translateY(1px)}
    /* Layout */
    .main{max-width:1200px;width:100%;margin:18px auto;padding:0 18px;display:grid;grid-template-columns:320px 1fr;gap:18px}
    @media (max-width: 950px){.main{grid-template-columns:1fr}}
    /* Card */
    .card{background:linear-gradient(180deg,rgba(19,26,42,.9),rgba(19,26,42,.7));border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .hd{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid var(--line)}
    .card .bd{padding:14px 16px}
    .hd h3{margin:0;font-size:14px;letter-spacing:.3px;color:#cfe2ff;text-transform:uppercase}
    .sub{color:var(--muted);font-size:12px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .grid{display:grid;gap:12px}
    .grid-2{grid-template-columns:1fr 1fr}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-auto{grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
    /* Inputs */
    label{font-size:12px;color:var(--muted)}
    .input,.select{display:flex;flex-direction:column;gap:6px}
    select,button,input[type="number"]{appearance:none;background:linear-gradient(180deg,rgba(24,33,54,.9),rgba(24,33,54,.7));border:1px solid var(--line);border-radius:12px;color:var(--text);padding:12px 14px;font-weight:600;outline:none}
    select:focus, input:focus{border-color:#4366ff;box-shadow:0 0 0 4px rgba(67,102,255,.18)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:10px;font-weight:800;padding:14px 16px;border-radius:12px;border:1px solid #2b3a5d;background:linear-gradient(180deg,#1b2a4a,#15213a);cursor:pointer;transition:transform .04s ease, box-shadow .2s ease}
    .btn:hover{box-shadow:0 10px 30px rgba(96,165,250,.2)}
    .btn:active{transform:translateY(1px)}
    .btn-primary{border-color:#3b82f6;background:linear-gradient(180deg,#2563eb,#1d4ed8);color:white;box-shadow:0 10px 30px rgba(37,99,235,.25)}
    .btn-buy{background:linear-gradient(180deg,#22c55e,#16a34a);border-color:#22c55e;color:#05210f}
    .btn-sell{background:linear-gradient(180deg,#ef4444,#dc2626);border-color:#ef4444;color:white}
    .btn-ghost{background:transparent;border-color:var(--line);color:var(--muted)}
    .kpi{display:flex;flex-direction:column;gap:6px;padding:10px 12px;border:1px dashed var(--line);border-radius:12px;background:linear-gradient(180deg,rgba(24,33,54,.4),rgba(24,33,54,.2))}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    /* Watchlist */
    .watchlist{display:flex;gap:10px;overflow:auto;padding:10px 2px}
    .ticker{min-width:140px;background:linear-gradient(180deg,rgba(24,33,54,.9),rgba(24,33,54,.6));border:1px solid var(--line);border-radius:12px;padding:10px}
    .ticker .sym{font-weight:800}
    .chg.up{color:var(--buy)} .chg.down{color:var(--sell)}
    /* Chart */
    .chart-wrap{position:relative;height:380px}
    @media (max-width: 950px){.chart-wrap{height:320px}}
    canvas{display:block;width:100%;height:100%}
    .watermark{position:absolute;inset:0;display:grid;place-items:center;pointer-events:none;opacity:.06;font-weight:900;font-size:72px;letter-spacing:6px}
    /* Signal */
    .signal-badge{display:inline-flex;align-items:center;gap:10px;padding:10px 14px;border-radius:999px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(24,33,54,.8),rgba(24,33,54,.5));font-weight:800}
    .sig-buy{color:var(--buy)} .sig-sell{color:var(--sell)} .sig-hold{color:var(--warn)}
    .confidence{display:flex;align-items:center;gap:14px}
    .gauge{width:76px;height:76px}
    .levels{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
    .lvl{background:linear-gradient(180deg,rgba(24,33,54,.8),rgba(24,33,54,.5));border:1px solid var(--line);border-radius:12px;padding:10px 12px}
    .lvl .v{font-weight:800}
    .exp{display:grid;gap:8px;margin-top:10px}
    .exp .li{display:flex;gap:10px;align-items:flex-start}
    .li b{color:#cfe2ff}
    /* Footer */
    .foot{padding:18px;color:var(--muted);text-align:center}
    .badge{display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border:1px solid var(--line);border-radius:12px;background:linear-gradient(180deg,rgba(24,33,54,.6),rgba(24,33,54,.3))}
    /* Loading overlay */
    .overlay{position:fixed;inset:0;background:rgba(6,10,18,.85);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:100}
    .load{display:grid;place-items:center;gap:14px;padding:24px;border-radius:16px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(24,33,54,.95),rgba(24,33,54,.8));box-shadow:var(--shadow);min-width:280px}
    .spinner{width:64px;height:64px;border-radius:999px;border:5px solid rgba(96,165,250,.25);border-top-color:#60a5fa;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress{width:100%;height:8px;background:rgba(96,165,250,.2);border-radius:999px;overflow:hidden}
    .progress .bar{height:100%;width:0;background:linear-gradient(90deg,#60a5fa,#5eead4);box-shadow:0 0 24px rgba(94,234,212,.45) inset;transition:width .25s ease}
    /* Toast */
    .toast{position:fixed;right:16px;bottom:16px;display:grid;gap:8px;z-index:101}
    .toast .t{display:flex;align-items:center;gap:10px;background:linear-gradient(180deg,rgba(24,33,54,.95),rgba(24,33,54,.85));border:1px solid var(--line);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow)}
    .t.ok{border-color:#1f6c4e}
    .t.warn{border-color:#6b4d1e}
    .t.err{border-color:#6c1f1f}
    /* Settings modal */
    .modal{position:fixed;inset:0;background:rgba(6,10,18,.72);backdrop-filter:blur(8px);display:none;align-items:center;justify-content:center;z-index:120}
    .modal .panel{width:min(680px,92vw);background:linear-gradient(180deg,rgba(24,33,54,.95),rgba(24,33,54,.85));border:1px solid var(--line);border-radius:18px;box-shadow:var(--shadow);overflow:hidden}
    .panel .head{display:flex;align-items:center;justify-content:space-between;padding:16px 18px;border-bottom:1px solid var(--line)}
    .panel .body{padding:16px 18px;display:grid;gap:12px}
    .switch{--h:28px;position:relative;width:54px;height:var(--h);background:#203051;border-radius:999px;border:1px solid var(--line);cursor:pointer}
    .switch::after{content:"";position:absolute;top:50%;left:4px;width:22px;height:22px;transform:translateY(-50%);border-radius:999px;background:#9fb0d1;transition:left .2s ease, background .2s ease}
    .switch.on{background:#234b36}
    .switch.on::after{left:28px;background:#34d399}
    .note{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
<div class="app">
  <!-- Top Nav -->
  <div class="nav">
    <div class="nav-inner">
      <div class="logo">
        <div class="logo-badge" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M3 12c0-5 4-9 9-9s9 4 9 9" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 12c0 5 4 9 9 9 3 0 5-1.5 7-4" stroke="white" stroke-width="2" stroke-linecap="round" opacity=".8"/>
            <circle cx="12" cy="12" r="3.5" fill="white"/>
          </svg>
        </div>
        <div>
          <div class="title">Oráculo Crypto</div>
          <div class="sub">IA de Sinais</div>
        </div>
      </div>
      <div class="pill">
        <div class="status"><span class="dot" id="conn-dot"></span><span class="latency">Conexão: <b id="latency">42ms</b> • UTC <span id="utc">--:--:--</span></span></div>
        <button id="btnSettings" class="gear" title="Configurações" aria-label="Configurações">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 15.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7Z" stroke="#cfe2ff" stroke-width="1.8"/><path d="M19.4 15a1.6 1.6 0 0 0 .32 1.76l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.6 1.6 0 0 0-1.76-.32 1.6 1.6 0 0 0-.95 1.46V21a2 2 0 1 1-4 0v-.06a1.6 1.6 0 0 0-.95-1.46 1.6 1.6 0 0 0-1.76.32l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.6 1.6 0 0 0 5 15.4a1.6 1.6 0 0 0-1.46-.95H3a2 2 0 1 1 0-4h.06A1.6 1.6 0 0 0 4.52 9.5c.21-.62.07-1.3-.32-1.76l-.06-.06A2 2 0 1 1 7 4.85l.06.06c.46.39 1.14.53 1.76.32A1.6 1.6 0 0 0 9.77 3.8V3a2 2 0 1 1 4 0v.06c0 .64.37 1.22.95 1.46.62.21 1.3.07 1.76-.32L17.54 4a2 2 0 1 1 2.83 2.83l-.06.06c-.39.46-.53 1.14-.32 1.76.23.58.81.95 1.45.95H22a2 2 0 1 1 0 4h-.06c-.64 0-1.22.37-1.46.95Z" stroke="#9fb0d1" stroke-width="1"/></svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Main -->
  <div class="main">
    <!-- Controls -->
    <div class="card" id="controls">
      <div class="hd"><h3>Menu de Operação</h3><span class="sub">Configure e gere o sinal</span></div>
      <div class="bd grid grid-auto">
        <div class="select">
          <label for="asset">Ativo</label>
          <select id="asset">
            <option value="BTCUSD" data-base="65000">Bitcoin (BTC)</option>
            <option value="ETHUSD" data-base="3200">Ethereum (ETH)</option>
            <option value="SOLUSD" data-base="165">Solana (SOL)</option>
            <option value="ADAUSD" data-base="0.55">Cardano (ADA)</option>
            <option value="XRPUSD" data-base="0.75">XRP (XRP)</option>
          </select>
        </div>
        <div class="select">
          <label for="tf">Timeframe</label>
          <select id="tf">
            <option value="5">5s</option>
            <option value="15">15s</option>
            <option value="60" selected>1m</option>
            <option value="300">5m</option>
          </select>
        </div>
        <div class="select">
          <label for="broker">Broker (destino)</label>
          <select id="broker">
            <option value="iq">IQ Option</option>
            <option value="quotex">Quotex</option>
            <option value="deriv">Deriv</option>
            <option value="pocket">Pocket Option</option>
            <option value="custom">Outro</option>
          </select>
        </div>
        <div class="input" id="customWrap" style="display:none">
          <label for="customUrl">URL custom (opcional)</label>
          <input id="customUrl" placeholder="https://minhabroker.com/trade?asset=BTCUSD" />
        </div>
        <div class="input">
          <label for="risk">Risco por operação</label>
          <select id="risk">
            <option value="0.5">0,5%</option>
            <option value="1" selected>1%</option>
            <option value="2">2%</option>
          </select>
        </div>
        <div class="input">
          <label for="balance">Banca</label>
          <input id="balance" type="number" min="50" step="50" value="10000" />
        </div>
        <div class="row" style="margin-top:4px">
          <button class="btn btn-primary" id="btnSignal">Obter Sinal de IA</button>
          <button class="btn btn-ghost" id="btnPaper">Paper Trade</button>
        </div>
      <div class="bd">
        <div class="sub">Watchlist</div>
        <div class="watchlist" id="watchlist"></div>
      </div>
    </div>

    <!-- Right side: Chart + Signal -->
    <div class="grid" style="gap:18px">
      <!-- Chart -->
      <div class="card">
        <div class="hd"><h3>Gráfico em tempo real</h3><span class="sub mono" id="chartMeta">BTCUSD • 1m • OHLC + EMA20/50 • RSI14</span></div>
        <div class="bd">
          <div class="chart-wrap">
            <canvas id="chart" aria-label="Candlestick chart"></canvas>
            <div class="watermark"></div>
          </div>
        </div>
      </div>

      <!-- Signal / Result -->
      <div class="card">
        <div class="hd"><h3>Resultado da IA</h3><span class="sub">Última análise</span></div>
        <div class="bd">
          <div class="row" style="justify-content:space-between">
            <div class="signal-badge" id="signalBadge"><span>—</span></div>
            <div class="confidence">
              <svg class="gauge" viewBox="0 0 42 42">
                <circle cx="21" cy="21" r="18" fill="none" stroke="#1f2a44" stroke-width="4"></circle>
                <circle id="gaugeArc" cx="21" cy="21" r="18" fill="none" stroke="url(#g)" stroke-width="4" stroke-linecap="round" stroke-dasharray="0 113" transform="rotate(-90 21 21)"></circle>
                <defs><linearGradient id="g" x1="0" x2="1"><stop offset="0" stop-color="#60a5fa"/><stop offset="1" stop-color="#5eead4"/></linearGradient></defs>
                <text id="gaugeTxt" x="21" y="23" text-anchor="middle" font-size="10" fill="#e6eefd" font-weight="800">0%</text>
              </svg>
              <div>
                <div class="sub">Confiança do modelo</div>
                <div class="mono" id="confInfo">—</div>
              </div>
            </div>
          </div>

          <div class="levels" style="margin-top:12px">
            <div class="lvl"><div class="sub">Entrada</div><div class="v mono" id="entry">—</div></div>
            <div class="lvl"><div class="sub">Stop</div><div class="v mono" id="stop">—</div></div>
            <div class="lvl"><div class="sub">Take</div><div class="v mono" id="take">—</div></div>
          </div>

          <div class="exp">
            <div class="li"><b>Justificativa:</b><span id="why">—</span></div>
            <div class="li"><b>Indicadores:</b><span id="inds">EMA20/50, RSI14, ATR14</span></div>
            <div class="li"><b>Risco estimado:</b><span id="riskEst">—</span></div>
          </div>

          <div class="row" style="margin-top:12px;gap:10px;flex-wrap:wrap">
            <button class="btn btn-buy" id="btnOpen">Abrir na Broker</button>
            <button class="btn" id="btnCopy">Copiar Sinal</button>
            <button class="btn btn-ghost" id="btnExport">Exportar JSON</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="foot">
    <span class="badge"></span>
  </div>
</div>

<!-- Loading Overlay -->
<div class="overlay" id="overlay">
  <div class="load">
    <div class="spinner" aria-hidden="true"></div>
    <div class="mono" id="loadMsg">Conectando aos feeds...</div>
    <div class="progress"><div class="bar" id="bar"></div></div>
  </div>
</div>

<!-- Settings Modal -->
<div class="modal" id="modal">
  <div class="panel">
    <div class="head">
      <div class="row">
        <strong>Configurações</strong>
        <span class="sub">Preferências do app</span>
      </div>
      <button class="btn btn-ghost" id="btnCloseModal">Fechar</button>
    </div>
    <div class="body grid grid-2">
      <div>
        <div class="sub">Tema</div>
        <div class="note">Este protótipo usa tema escuro moderno.</div>
      </div>
      <div>
        <div class="sub">Som de notificação</div>
        <div class="row">
          <div id="swSound" class="switch" role="switch" aria-checked="false"></div>
          <div class="note">Tocar bip ao gerar novo sinal</div>
        </div>
      </div>
      <div>
        <div class="sub">Execução de ordem</div>
        <div class="row">
          <div id="swPaper" class="switch on" role="switch" aria-checked="true"></div>
          <div class="note">Paper trading ativado (não envia ordens reais)</div>
        </div>
      </div>
      <div>
        <div class="sub">Idioma</div>
        <div class="note">PT-BR (fixo no protótipo)</div>
      </div>
      <div class="grid" style="grid-column:1/-1">
        <div class="kpi">
          <div class="sub">Compliance & Aviso</div>
          <div class="note">Risco alto. Este projeto é <b>educacional</b>, sem promessa de ganhos. Opções binárias e derivativos podem resultar em perda total do capital.</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast" id="toast"></div>

<script>
/* ========= UTIL ========= */
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const fmt = (n, dp=2) => Number(n).toLocaleString('en-US',{minimumFractionDigits:dp, maximumFractionDigits:dp});
const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
const rnd = (a,b)=>a+Math.random()*(b-a);
const toast = (msg,type='ok',ms=2700)=>{
  const el=document.createElement('div'); el.className=`t ${type}`; el.innerHTML=`${msg}`;
  $('#toast').appendChild(el); setTimeout(()=>el.remove(),ms);
};
const beep = ()=>{
  if(!state.soundOn) return;
  const ctx = new (window.AudioContext||window.webkitAudioContext)();
  const o = ctx.createOscillator(); const g = ctx.createGain();
  o.type='sine'; o.frequency.value=880; g.gain.setValueAtTime(.0001,ctx.currentTime);
  o.connect(g); g.connect(ctx.destination);
  g.gain.exponentialRampToValueAtTime(.15, ctx.currentTime+.01);
  o.start(); setTimeout(()=>{g.gain.exponentialRampToValueAtTime(.0001, ctx.currentTime+.01); o.stop(); ctx.close();},140);
};
const storage = {
  get:k=>JSON.parse(localStorage.getItem(k)||'null'),
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
/* ========= STATE ========= */
const state = {
  prices:[], // candles
  tf: 60,    // seconds per candle (simulation)
  base: 65000,
  asset: 'BTCUSD',
  ema20:[], ema50:[],
  rsi14:[],
  atr14:[],
  running: true,
  soundOn: false,
  paperOn: true,
  lastSignal: null
};
/* ========= WATCHLIST ========= */
const symbols = [
  {sym:'BTCUSD', name:'Bitcoin', base:65000},
  {sym:'ETHUSD', name:'Ethereum', base:3200},
  {sym:'SOLUSD', name:'Solana', base:165},
  {sym:'ADAUSD', name:'Cardano', base:0.55},
  {sym:'XRPUSD', name:'XRP', base:0.75},
];
function buildWatchlist(){
  const wrap = $('#watchlist'); wrap.innerHTML='';
  symbols.forEach(s=>{
    const chg = rnd(-2.4,2.4); const price = s.base * (1 + chg/100);
    const div = document.createElement('div');
    div.className='ticker';
    div.innerHTML = `
      <div class="row" style="justify-content:space-between">
        <div class="sym">${s.sym}</div>
        <div class="chg ${chg>=0?'up':'down'}">${chg>=0?'+':''}${chg.toFixed(2)}%</div>
      </div>
      <div class="sub mono">≈ ${fmt(price, s.base<5 ? 4 : 2)}</div>
    `;
    wrap.appendChild(div);
  });
}
/* ========= CHART ========= */
const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
const chart = $('#chart'); const ctx = chart.getContext('2d');
let W=0,H=0, PAD=54, VISIBLE=160, lastDraw=0;
function resize(){
  const rect = chart.parentElement.getBoundingClientRect();
  W = Math.floor(rect.width * dpr); H = Math.floor(rect.height * dpr);
  chart.width=W; chart.height=H; chart.style.width = rect.width+'px'; chart.style.height = rect.height+'px';
  draw();
}
window.addEventListener('resize', resize);
/* ========= DATA (sim) ========= */
function seedData(){
  state.prices=[]; const base=state.base; let last=base;
  for(let i=0;i<VISIBLE;i++){
    const vol = Math.max(0.3, Math.random()); // volatility factor
    const drift = rnd(-0.09,0.09);
    const open = last;
    const move = open * (drift/100);
    const close = open + move + rnd(-vol,vol);
    const high = Math.max(open,close) + Math.abs(rnd(0, vol*0.8));
    const low  = Math.min(open,close) - Math.abs(rnd(0, vol*0.8));
    state.prices.push({o:open,h:high,l:low,c:close});
    last=close;
  }
  calcIndicators();
}
function tick(){
  // evolve last candle slightly and sometimes push a new one (per ~2 seconds)
  if(state.prices.length===0) return;
  const p = state.prices[state.prices.length-1];
  const vol = Math.max(0.3, Math.random());
  const move = p.c * rnd(-0.08,0.08)/100;
  const nc = p.c + move;
  p.h=Math.max(p.h,nc); p.l=Math.min(p.l,nc); p.c=nc;
  if(Math.random()<0.25){ // open new candle
    const last = state.prices[state.prices.length-1].c;
    const open = last;
    const close = open + open * rnd(-0.18,0.18)/100;
    const high = Math.max(open,close)+Math.abs(rnd(0, open*0.001));
    const low  = Math.min(open,close)-Math.abs(rnd(0, open*0.001));
    state.prices.push({o:open,h:high,l:low,c:close});
    if(state.prices.length>VISIBLE) state.prices.shift();
    calcIndicators();
  }
}
function ema(src, period){
  const k = 2/(period+1); const out=[];
  let e = src[0];
  for(let i=0;i<src.length;i++){ e = src[i]*k + e*(1-k); out.push(e); }
  return out;
}
function rsi(src, period=14){
  let gains=0, losses=0; const out=[];
  for(let i=1;i<src.length;i++){
    const ch = src[i]-src[i-1];
    gains = (gains*(period-1) + Math.max(0,ch))/period;
    losses = (losses*(period-1) + Math.max(0,-ch))/period;
    const rs = losses===0 ? 100 : gains/losses;
    const val = losses===0 ? 100 : 100 - 100/(1+rs);
    out.push(val);
  }
  out.unshift(out[0]||50);
  return out;
}
function atr(candles, period=14){
  const trs=[candles[0].h - candles[0].l];
  for(let i=1;i<candles.length;i++){
    const prev = candles[i-1].c;
    const c = candles[i];
    const tr = Math.max(c.h-c.l, Math.abs(c.h-prev), Math.abs(c.l-prev));
    trs.push(tr);
  }
  // simple EMA-like smoothing
  const out=[]; let a = trs[0];
  const k = 2/(period+1);
  for(let i=0;i<trs.length;i++){ a = trs[i]*k + a*(1-k); out.push(a); }
  return out;
}
function calcIndicators(){
  const closes = state.prices.map(p=>p.c);
  state.ema20 = ema(closes,20);
  state.ema50 = ema(closes,50);
  state.rsi14 = rsi(closes,14);
  state.atr14 = atr(state.prices,14);
}
function draw(ts=0){
  if(ts - lastDraw < 33){ requestAnimationFrame(draw); return; } // ~30fps cap
  lastDraw=ts;
  ctx.clearRect(0,0,W,H);
  if(state.prices.length<2) return;
  // bounds
  const min = Math.min(...state.prices.map(p=>p.l));
  const max = Math.max(...state.prices.map(p=>p.h));
  const padY = (max-min)*0.08;
  const yMin = min - padY, yMax = max + padY;
  const x0 = PAD, x1 = W-PAD, y0 = PAD*0.8, y1 = H-PAD*1.2;
  const n = state.prices.length;
  const cw = (x1-x0)/n;
  // axes
  ctx.strokeStyle='#233153'; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(x0, y1); ctx.lineTo(x1, y1); ctx.stroke();
  // y ticks
  ctx.fillStyle='#9fb0d1'; ctx.font = `${12*dpr}px Inter`;
  for(let t=0;t<=4;t++){
    const yv = yMax - (yMax-yMin)*t/4;
    const y = y0 + (y1-y0)*t/4;
    ctx.globalAlpha=.4; ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x1, y); ctx.stroke(); ctx.globalAlpha=1;
    const label = fmt(yv, (yMax<10)?4:2);
    ctx.fillText(label, 8*dpr, y+4*dpr);
  }
  // candles
  for(let i=0;i<n;i++){
    const c = state.prices[i];
    const x = x0 + i*cw + cw*0.1;
    const w = cw*0.8;
    const yH = y0 + (y1-y0)*(1-(c.h - yMin)/(yMax-yMin));
    const yL = y0 + (y1-y0)*(1-(c.l - yMin)/(yMax-yMin));
    const yO = y0 + (y1-y0)*(1-(c.o - yMin)/(yMax-yMin));
    const yC = y0 + (y1-y0)*(1-(c.c - yMin)/(yMax-yMin));
    ctx.strokeStyle = (c.c>=c.o)?'#22c55e':'#ef4444'; ctx.lineWidth=1.2;
    // wick
    ctx.beginPath(); ctx.moveTo(x+w/2,yH); ctx.lineTo(x+w/2,yL); ctx.stroke();
    // body
    ctx.fillStyle = (c.c>=c.o)?'rgba(34,197,94,.9)':'rgba(239,68,68,.9)';
    const bh = Math.max(2, Math.abs(yC - yO));
    ctx.fillRect(x, Math.min(yC,yO), w, bh);
  }
  // EMA lines
  const plotLine = (arr,color)=>{
    ctx.strokeStyle=color; ctx.lineWidth=1.6; ctx.beginPath();
    for(let i=0;i<n;i++){
      const v = arr[i], x = x0 + i*cw + cw/2;
      const y = y0 + (y1-y0)*(1-(v - yMin)/(yMax-yMin));
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    }
    ctx.stroke();
  };
  plotLine(state.ema20,'#60a5fa'); plotLine(state.ema50,'#5eead4');
  requestAnimationFrame(draw);
}
/* ========= SIGNAL ENGINE (heuristic demo) ========= */
function genSignal(){
  const N = state.prices.length; if(N<50) return null;
  const c = state.prices[N-1].c;
  const e20 = state.ema20[N-1], e50 = state.ema50[N-1];
  const rsi = state.rsi14[N-1];
  const atr = state.atr14[N-1];
  const momentum = (state.prices[N-1].c - state.prices[N-6]?.c) || 0;
  let side='HOLD', score=50, why=[];
  // rules
  if(e20>e50){score+=12; why.push('EMA20 acima da EMA50');} else {score-=12; why.push('EMA20 abaixo da EMA50');}
  if(rsi>55){score+=8; why.push('RSI14 > 55 (força compradora)');}
  if(rsi<45){score-=8; why.push('RSI14 < 45 (força vendedora)');}
  if(momentum>0){score+=6; why.push('Momentum positivo');}
  if(momentum<0){score-=6; why.push('Momentum negativo');}
  // normalize
  score = clamp(Math.round(score), 1, 99);
  if(score>=57 && e20>e50) side='BUY';
  if(score<=43 && e20<e50) side='SELL';
  // levels
  const entry = c;
  const stop  = side==='BUY' ? c - atr*1.2 : side==='SELL' ? c + atr*1.2 : c - atr*2;
  const take  = side==='BUY' ? c + atr*1.8 : side==='SELL' ? c - atr*1.8 : c;
  const riskPct = (Math.abs(entry-stop)/entry)*100;
  return {
    ts: new Date().toISOString(),
    asset: state.asset, tf: state.tf,
    side, score, entry, stop, take,
    rsi: Math.round(rsi), ema20:e20, ema50:e50, atr,
    why, riskPct
  };
}
/* ========= UI BIND ========= */
function updateHeaderMeta(){
  $('#chartMeta').textContent = `${state.asset} • ${tfLabel(state.tf)} • OHLC + EMA20/50 • RSI14`;
}
function tfLabel(tf){
  const map={5:'5s',15:'15s',60:'1m',300:'5m'};
  return map[tf]|| (tf+'s');
}
function renderSignal(sig){
  const badge = $('#signalBadge'); const span = badge.querySelector('span');
  badge.classList.remove('sig-buy','sig-sell','sig-hold');
  if(sig.side==='BUY'){badge.classList.add('sig-buy'); span.textContent='🚀 COMPRA (BUY)';}
  else if(sig.side==='SELL'){badge.classList.add('sig-sell'); span.textContent='🧨 VENDA (SELL)';}
  else {badge.classList.add('sig-hold'); span.textContent='⏸️ Aguardar (HOLD)';}
  // gauge
  const arc = $('#gaugeArc'); const txt = $('#gaugeTxt');
  const len = 2*Math.PI*18; const dash = Math.round(len*(sig.score/100));
  arc.setAttribute('stroke-dasharray', `${dash} ${len-dash}`);
  txt.textContent = sig.score+'%';
  $('#confInfo').textContent = `score=${sig.score} • RSI=${sig.rsi}`;
  $('#entry').textContent = 'US$ '+fmt(sig.entry, sig.entry<10?4:2);
  $('#stop').textContent  = 'US$ '+fmt(sig.stop, sig.entry<10?4:2);
  $('#take').textContent  = 'US$ '+fmt(sig.take, sig.entry<10?4:2);
  $('#why').textContent = sig.why.join(' · ');
  $('#riskEst').textContent = `${fmt(sig.riskPct,2)}% do preço (~${fmt(sig.atr,2)} ATR)`;
}
function openOverlay(){
  $('#overlay').style.display='flex';
  const msgs=[
    'Conectando aos feeds...',
    'Sincronizando relógio com UTC...',
    'Analisando volatilidade intrínseca...',
    'Calculando EMA/RSI/ATR...',
    'Estimando probabilidade de rompimento...',
    'Gerando explicações da decisão...'
  ];
  let step=0, prog=0;
  const bar = $('#bar'); const txt=$('#loadMsg');
  const timer = setInterval(()=>{
    prog = clamp(prog + rnd(6,14), 0, 100);
    bar.style.width = prog+'%';
    if(Math.random()<.5 && step<msgs.length-1){ step++; txt.textContent = msgs[step]; }
    if(prog>=100){ clearInterval(timer); setTimeout(closeOverlay, 250); }
  }, 180);
}
function closeOverlay(){ $('#overlay').style.display='none'; }
function brokersMap(code, urlCustom){
  const map = {
    iq:'https://iqoption.com/en/traderoom',
    quotex:'https://quotex.io/pt/traderoom',
    deriv:'https://app.deriv.com',
    pocket:'https://pocketoption.com/en/',
    custom:urlCustom||'#'
  };
  return map[code] || '#';
}
/* ========= INIT ========= */
function init(){
  // restore prefs
  const pref = storage.get('oracle-prefs') || {};
  state.soundOn = !!pref.soundOn; state.paperOn = pref.paperOn!==false;
  if(state.soundOn) $('#swSound').classList.add('on');
  if(state.paperOn) $('#swPaper').classList.add('on');
  // select bindings
  $('#asset').addEventListener('change', e=>{
    const opt = e.target.selectedOptions[0];
    state.asset = opt.value; state.base = parseFloat(opt.dataset.base||'65000');
    seedData(); updateHeaderMeta(); draw();
  });
  $('#tf').addEventListener('change', e=>{
    state.tf = parseInt(e.target.value,10); updateHeaderMeta();
  });
  $('#broker').addEventListener('change', e=>{
    $('#customWrap').style.display = e.target.value==='custom' ? 'block':'none';
  });
  $('#btnSignal').addEventListener('click', ()=>{
    openOverlay();
    setTimeout(()=>{
      const sig = genSignal();
      if(!sig){ toast('Dados insuficientes para gerar sinal','warn'); return closeOverlay(); }
      state.lastSignal=sig; renderSignal(sig); beep();
      closeOverlay();
      toast(`<span class="mono">Sinal ${sig.side} ${sig.asset}</span> pronto`);
    }, 950);
  });
  $('#btnCopy').addEventListener('click', ()=>{
    if(!state.lastSignal) return toast('Gere um sinal primeiro','warn');
    const s = state.lastSignal;
    const txt = `SIGNAL ${s.asset} ${s.side}\nEntry: ${fmt(s.entry)}\nStop: ${fmt(s.stop)}\nTake: ${fmt(s.take)}\nConf: ${s.score}% • RSI ${s.rsi}\nWhy: ${s.why.join(' / ')}\n${new Date().toLocaleString()}`;
    navigator.clipboard.writeText(txt); toast('Sinal copiado 📋');
  });
  $('#btnExport').addEventListener('click', ()=>{
    if(!state.lastSignal) return toast('Gere um sinal primeiro','warn');
    const blob = new Blob([JSON.stringify(state.lastSignal,null,2)], {type:'application/json'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download=`signal_${state.lastSignal.asset}_${Date.now()}.json`; a.click();
    URL.revokeObjectURL(a.href);
  });
  $('#btnOpen').addEventListener('click', ()=>{
    const broker = $('#broker').value;
    const url = brokersMap(broker, $('#customUrl').value.trim());
    toast('Integração desativada no modo DEMO','warn');
    window.open(url,'_blank','noopener');
  });
  $('#btnPaper').addEventListener('click', ()=>{
    if(!state.lastSignal) return toast('Gere um sinal primeiro','warn');
    const bal = parseFloat($('#balance').value||'0');
    const riskPct = parseFloat($('#risk').value||'1');
    const stake = bal * (riskPct/100);
    toast(`Paper trade simulado • Stake: $${fmt(stake,2)} • ${state.lastSignal.side}`,'ok',3400);
  });
  // Settings
  $('#btnSettings').addEventListener('click', ()=>{$('#modal').style.display='flex';});
  $('#btnCloseModal').addEventListener('click', ()=>{$('#modal').style.display='none';savePrefs();});
  $('#swSound').addEventListener('click', e=>{ e.currentTarget.classList.toggle('on'); state.soundOn = e.currentTarget.classList.contains('on'); savePrefs(); });
  $('#swPaper').addEventListener('click', e=>{ e.currentTarget.classList.toggle('on'); state.paperOn = e.currentTarget.classList.contains('on'); savePrefs(); });

  // time + latency pulse
  setInterval(()=>{
    $('#utc').textContent = new Date().toISOString().substr(11,8);
    const l = Math.floor(rnd(28,86)); $('#latency').textContent = l+'ms';
    const dot = $('#conn-dot'); dot.style.background = l<70? 'var(--ok)': 'var(--warn)';
    dot.style.boxShadow = l<70? '0 0 0 2px rgba(16,185,129,.25)' : '0 0 0 2px rgba(245,158,11,.25)';
  }, 1000);

  // prime data
  buildWatchlist();
  seedData(); resize(); draw();
  setInterval(()=>{ tick(); }, 750);
  setInterval(buildWatchlist, 6000);

  updateHeaderMeta();
}
function savePrefs(){ storage.set('oracle-prefs', {soundOn: state.soundOn, paperOn: state.paperOn}); }
window.addEventListener('load', init);
</script>
</body>
</html>
